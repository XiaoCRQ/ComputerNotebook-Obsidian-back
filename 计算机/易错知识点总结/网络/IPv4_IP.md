# 🛠 IPv4 地址分配与续租机制

## 📦 一、IP 地址的分配方式

### 1. 静态分配（Static IP）
- 手动为每台设备分配 IP 地址。
- 地址固定，常用于服务器、打印机等需要固定 IP 的设备。
- 优点：通信稳定，便于端口映射与访问管理。
- 缺点：不易管理，易产生地址冲突。

### 2. 动态分配（Dynamic IP）
- 通过 **DHCP（Dynamic Host Configuration Protocol）** 自动分配 IP 地址。
- 适用于普通终端设备（如手机、电脑等）。
- 地址通常是临时租用的，会过期。

---

## ⏳ 二、DHCP 的 IP 地址租约机制

DHCP 使用 **“租约（Lease）”** 的概念来临时分配 IP 地址，以下是其生命周期：

### 📌 1. IP 地址租约流程（四个阶段）

1. **DHCP Discover**：客户端广播请求 IP。
2. **DHCP Offer**：服务器响应并提供一个可用 IP。
3. **DHCP Request**：客户端选择其中一个 IP 并请求使用。
4. **DHCP Acknowledgment**：服务器确认，租约开始。

### 📆 2. 租约续租机制（租约周期 = T）

| 时间点          | 动作                                   |
|------------------|----------------------------------------|
| `T1 = 50%`       | 客户端向原 DHCP 服务器发送续租请求（unicast） |
| `T2 = 87.5%`     | 若 T1 未响应，客户端广播请求任何 DHCP 服务器续租 |
| `T3 = 100%`      | 若仍无响应，租约过期，重新开始 DHCP Discover |

> 💡 如果服务器响应了续租请求，租约时间将被重置。

---

## 🧠 三、DHCP 与续租常见问题

### 1. **IP地址冲突**
- 原因：静态 IP 与动态 IP 冲突，或多个 DHCP 服务器配置错误。
- 解决：确保静态 IP 不在 DHCP 分配范围内。

### 2. **续租失败**
- 原因：DHCP 服务关闭、服务器不可达。
- 解决：
  - 检查 DHCP 服务状态；
  - 检查网络连通性；
  - 手动释放并续租 IP。

### 3. **手动释放/续租命令（Windows）**

```bash
ipconfig /release   # 释放 IP
ipconfig /renew     # 重新获取 IP
```

---

## 🛡 四、租约时间配置（DHCP 服务器端）

在 DHCP 服务配置中可以设置租约时间：

- **最短租期**：几分钟（适用于临时访客网络）
- **标准租期**：8 小时、24 小时（企业常用）
- **最长租期**：数周（少变动网络）

```ini
# Linux DHCP 配置（/etc/dhcp/dhcpd.conf 示例）

default-lease-time 600;     # 默认租约时间，单位：秒
max-lease-time 7200;        # 最大租约时间，单位：秒
```

---

## 📍 总结

- DHCP 实现了 IP 分配的自动化和灵活性。
- 租约机制可确保网络资源合理利用，防止 IP 冲突。
- 网络故障排查时，掌握续租流程至关重要。
